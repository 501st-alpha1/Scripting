#!/bin/bash
# Helper script to install and update Emacs packages.
# Copyright (C) 2015-2017 Scott Weldon

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

validArgs=("basedir")
source loadconf "$HOME/.scott_script/emacs" "packages.cfg" validArgs[@]

github=("Bruce-Connor/names" "Bruce-Connor/aggressive-indent-mode" "sprang/emacs-2048" "auto-complete/auto-complete" "mina86/auto-dim-other-buffers.el" "jwiegley/emacs-chess" "editorconfig/editorconfig-emacs" "emacsmirror/emms" "501st-alpha1/facebook" "lewang/fic-mode" "lewang/flx" "syohex/emacs-git-gutter" "magit/magit" "jtatarik/magit-gitflow" "auto-complete/popup-el" "nonsequitur/inf-ruby" "magit/git-modes" "kazu-yamamoto/Mew" "mattkeller/mk-project" "org-trello/org-trello" "kiwanami/emacs-deferred" "tkf/emacs-request" "nex3/perspective-el" "bbatsov/projectile" "rejeep/f.el" "jwiegley/ruby-mode" "mbunkus/simple-rtm" "501st-alpha1/twittering-mode" "fxbois/web-mode" "vibhavp/emacs-xkcd" "yoshiki/yaml-mode" "magnars/dash.el" "winterTTr/ace-jump-mode" "abo-abo/ace-window" "abo-abo/avy" "501st-alpha1/emacs-auto-formatter" "dengste/doc-present" "spotify/dockerfile-mode" "michaelklishin/cucumber.el" "dominikh/go-mode.el" "DarwinAwardWinner/ido-ubiquitous" "purcell/less-css-mode" "jschaf/emacs-lorem-ipsum" "magit/orgit" "thieman/soundcloud.el" "rolandwalker/string-utils" "dougm/vagrant-tramp" "magit/with-editor" "bbatsov/persp-projectile" "company-mode/company-mode" "OmniSharp/omnisharp-emacs" "flycheck/flycheck" "NicolasPetton/seq.el" "magit/ssh-agency" "pashky/restclient.el" "magnars/s.el")

third_party=("jblevins.org/git/deft.git" "jblevins.org/git/markdown-mode.git" "orgmode.org/org-mode.git" "orgmode.org/org-sync.git")

function loadRepo() {
  url=$1
  if [ "${url:(-4)}" == ".git" ]
  then
    baseurl="${url:0:(-4)}"
  else
    baseurl=$url
  fi
  IFS='/' read -ra array <<< "$baseurl"
  len=${#array[@]}
  last=$(expr $len - 1)
  dir=$(echo ${array[$last]} | sed 's/\./-/g')

  if [ -d $dir ]
  then
    if [ $update -eq 0 ]
    then
      echo "Folder exists, skipping $url..."
    else
      pushd "$dir" > /dev/null
      git pull
      popd > /dev/null
      echo "Updated $dir"; echo;
    fi
  else
    git clone $url
    if [ "$dir" != "${array[1]}" ]
    then
      mv "${array[1]}" "$test"
    fi
  fi
}

if [ ! -d "$basedir" ]
then
  echo "Variable basedir is incorrectly configured."
  echo "It is '$basedir'."
  echo "It should be a folder."

  exit 1
fi

cd $basedir

if [ "$1" == "--no-update" ]
then
  update=0
else
  update=1
fi

if [ $update -eq 1 ]
then
  echo "Running ssh-add, please unlock once, if necessary."
  ssh-add -l > /dev/null
  if [ "$?" -ne 0 ]
  then
    ssh-add
  fi
fi

for name in ${github[*]}
do
  loadRepo ssh://git@github.com/$name
done

for url in ${third_party[*]}
do
  loadRepo git://$url
done

# FIXME: flycheck tests cause load errors.
if [ -d "flycheck/test" ]
then
   rm -rf flycheck/test
fi

pushd org-mode
make autoloads
popd

if [ ! -d "no-repos" ]
then
  mkdir no-repos
fi
cd no-repos

norepoarray=("http://www.emacswiki.org/emacs/download/csharp-mode.el" "http://www.emacswiki.org/emacs/download/csv-mode.el" "http://www.emacswiki.org/emacs/download/notify.el")

for file in ${norepoarray[*]}
do
  IFS='/' read -ra newarray <<< "$file"
  num=${#newarray}
  test=${newarray[$num]}
  if [ -f "$test" ]
  then
    echo "File exists, skipping $test"
  else
    wget $file
  fi
done

if [ ! -d "erc-5.3-extras" ]
then
  wget http://ftp.gnu.org/old-gnu/erc/erc-5.3-extras.zip
  unzip erc-5.3-extras.zip
else
  echo "Folder exists, skipping erc-chess."
fi
